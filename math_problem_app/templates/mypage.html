{% load static %}
<div class="row">
    <div class="col-xs-3 left-menu" align="center">
        <p class="large-font underline">{{ user.id }}</p>
        <div class="profile-circle"><span class="profile-char white-color">{{ user.name.0 }}</span></div>
        <p class="mypage-name x-large-font">{{ user.name }}</p>
        <p class="mypage-email small-font">{{ user.email }}</p>
        <p class="mypage-left-text medium-font">{{ user.school }} {{ user.get_grade_display }}</p>
    </div>
    <div class="col-xs-9" style="">
        <div class="row main-bottom main-background-color" align="center">
            <p class="main-bottom-msg white-color"><span class="x-large-font bold">{{ user.name }}</span><span class="large-font">의 실력은?</span></p>
        </div>
        <div class="row" align="center" style="margin-top: 2%; padding: 0 5% 0 5%">
            <div class="col-xs-2 x-large-font main-color bold">수1</div>
            <div class="col-xs-2 x-large-font main-color bold">수2</div>
            <div class="col-xs-2 x-large-font main-color bold">미1</div>
            <div class="col-xs-2 x-large-font main-color bold">미2</div>
            <div class="col-xs-2 x-large-font main-color bold">기벡</div>
            <div class="col-xs-2 x-large-font main-color bold">확통</div>
        </div>
        <div class="row">
            <div id="chartContainer" style="height: 50%; width: 97%;"></div>
        </div>
        <div class="row" align="right" style="padding-right: 5%">
            <div class="col-xs3 bold large-font">updated: <span id="created-at">{{ rate.get_updated_at }}</span></div>
        </div>
        <div id="test" class="row main-bottom main-background-color mypage-bottom" align="center">
            <p class="main-bottom-msg white-color mypage-bottom-msg"><span class="x-large-font bold">진단고사 보기</span></p>
        </div>

        <div class="row main-bottom main-background-color" align="center" style="margin-top: 5%;">
            <p class="main-bottom-msg white-color"><span class="x-large-font bold">{{ user.name }}</span><span class="large-font">의 진단결과는?</span></p>
        </div>
{#        <div class="large-font" align="center" style="margin-top: 3%">#}
{#            <span class="x-large-font">{{ user.name }}</span>의 {{ user.get_last_answer.get_created_at }}2018년 3월 24일 진단고사!#}
{#        </div>#}

        <div class="row" style="padding: 8% 2% 0 2%;">
            <div class="col-xs-6" align="right" style="padding-right: 4%">
                <div class="mypage-box x-large-font bold" align="center">
                    문제은행 히스토리
                </div>
                {% for recommend in user.recommend.all %}
                <div class="mypage-box list-group project-left-box-div">
                    <div class="row graph-title mypage-graph-title" data-open="false" align="left">
                        <div class="col-xs-8">
                            <p class="x-large-font bold">{{ recommend.unit.get_unit_display }}</p>
                            <p class="large-font">{{ recommend.aimGrade }}등급 만들기</p>
                        </div>
                        <div class="col-xs-4" style="margin-top: 50px;">
                            <img class="arrow-back mypage-arrow" src="{% static 'assets/img/arrow.png' %}">
                        </div>
                    </div>
                    <div class="list-group graph-box">
                        <div class="row">
                            <div class="col-xs-8">
                                <div class="doughnut-chart" id="doughnutChartContainer{{ forloop.counter }}" style="padding: 5% 5% 5% 5%; width: 100%; height: 200px;"></div>
                            </div>
                            <div class="col-xs-4" style="margin: 15% 0 0 -5%;" align="center">
                                <p class="large-font orange-color">0</p>
                                <p class="x-small-font gray-color">day streak</p>
                                <p class="large-font orange-color">6</p>
                                <p class="x-small-font gray-color">hours left</p>
                            </div>
                        </div>
                        <div class="row project-left-box" style="padding-left: 0; margin-left: -30%;">
                            <div class="chart" id="chartContainer{{ forloop.counter }}" style="padding: 10% 0% 10% 0; height: 200px; width: 350px;"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="col-xs-6" align="left" style="padding-left: 4%">
                <div class="mypage-box x-large-font bold" align="center">
                    진단고사 히스토리
                </div>
                {% for answer in user.get_answers %}
                <div class="mypage-box large-font bold estimate-box" data-createdat="{{ answer.get_created_at_dot }}" data-answersrl="{{ answer.answerSrl }}" align="center">
                    {{ answer.get_created_at }} 진단고사
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>


<script>
    history.pushState(null, null, "#mypage");
    $(window).unbind("hashchange")
    $(window).bind("hashchange", function(){
        goToMain()
    });

    {% if user %}
    $('#login').text('로그아웃')
    $('#login').unbind('click')
    $('#signup').css('display', 'none')
    $('#login').removeClass('border-right')
    $('#login').click(function () {
        $.ajax({
            url: "logout/",
            type: 'GET',
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                goToMain()
                alert(result.msg)
                $('#login').addClass('border-right')
                $('#signup').css('display', 'inherit')
            },
        });
    })
    {% else %}
    $('#login').text('로그인')
    $('#login').unbind('click')
    $('#login').click(function () {
        $.ajax({
            url: "login/",
            type: 'GET',
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                $('.main-container').empty()
                $('.main-container').append(result)
            },
        });
    })
    {% endif %}

    {% for recommend in user.recommend.all %}
        $.ajax({
            url: "getRateData/",
            type: 'GET',
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                drawGraph(result, 'chartContainer{{ forloop.counter }}')
            },
        });

        $.ajax({
            url: "getRateData/",
            type: 'GET',
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                drawDoughnutGraph(result, 'doughnutChartContainer{{ forloop.counter }}')
            },
        });
    {% endfor %}

    $('.graph-title').click(function () {
        if($(this).data('open') == false) {
            $(this).next('.graph-box ').css('height', '450px')
            $(this).data('open', true)
            $(this).children().children('.mypage-arrow').css('transform', 'rotate(90deg)')
            {% for recommend in user.recommend.all %}
            $.ajax({
                url: "getRateData/",
                type: 'GET',
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    drawGraph(result, 'chartContainer{{ forloop.counter }}')
                },
            });

            $.ajax({
                url: "getRateData/",
                type: 'GET',
                contentType: "application/json; charset=utf-8",
                success: function (result) {
                    drawDoughnutGraph(result, 'doughnutChartContainer{{ forloop.counter }}')
                },
            });
            {% endfor %}
        } else if($(this).data('open') == true){
            $(this).next('.graph-box ').css('height', '0')
            $(this).data('open', false)
            $(this).children().children('.mypage-arrow').css('transform', 'rotate(270deg)')
        }
    })


    $('#test').click(function () {
        $.ajax({
            url: "estimationStart/",
            type: 'GET',
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                $('.main-container').empty()
                $('.main-container').append(result)
            },
        });
    })

    $('.estimate-box').click(function () {
        var box = $(this)
        $.ajax({
            url: "getRateData/?answerSrl="+$(this).data('answersrl'),
            type: 'GET',
            contentType: "application/json; charset=utf-8",
            success: function (result) {
                drawMypageGraph(result)
                $('#created-at').text(box.data('createdat'))
            },
        });
    })

    $.ajax({
        url: "getRateData/",
        type: 'GET',
        contentType: "application/json; charset=utf-8",
        success: function (result) {
            drawMypageGraph(result)
        },
    });

    function drawMypageGraph(data) {
		var chart = new CanvasJS.Chart("chartContainer",{
			title:{
				text: ""
			},
            animationEnabled: true,
			axisY:{
				reversed: true,
                labelFontSize: 30,
                interval: 1,
                minimum: 0,
                maximum: 9,
			},
            axisX:{
			    labelFontSize: 40,
                labelFontColor: "#50519C",
            },
            backgroundColor: "#E5E7F5",
			data: [{
				type: "line",
				dataPoints: data,
                markerSize: 35,
                lineThickness: 6,
                color: "#47DFBA",
			}]
		});
	    chart.render();
	}

	$(".mypage-bottom-msg").mouseover(function(){
        $(this).css("color", "#20216C");
    });
    $(".mypage-bottom-msg").mouseleave(function(){
        $(this).css("color", "white");
    });

</script>